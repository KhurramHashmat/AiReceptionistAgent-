<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Chat</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0e0e10;
    --surface: #18181b;
    --surface2: #222226;
    --border: #2e2e34;
    --accent: #e8d5a3;
    --accent2: #c9a96e;
    --text: #f0ede6;
    --text-muted: #88877f;
    --user-bubble: #1e2a1e;
    --user-border: #3a5c3a;
    --ai-bubble: #1e1e28;
    --ai-border: #3a3a5c;
    --sidebar-w: 260px;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* ── SIDEBAR ── */
  .sidebar {
    width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 0;
    transition: width 0.3s cubic-bezier(0.4,0,0.2,1), border-right 0.3s;
    position: relative;
    z-index: 10;
    flex-shrink: 0;
    overflow: hidden;
    min-width: 0;
  }
  .sidebar.closed { width: 0; border-right: none; }

  .sidebar-header {
    padding: 20px 18px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .sidebar-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 1.1rem;
    color: var(--accent);
    letter-spacing: 0.02em;
  }

  .new-chat-btn {
    margin: 14px 12px;
    padding: 9px 14px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
  }
  .new-chat-btn:hover { border-color: var(--accent2); color: var(--accent); }

  .chat-history {
    flex: 1;
    overflow-y: auto;
    padding: 6px 8px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .chat-history-label {
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    padding: 8px 10px 4px;
  }
  .chat-item {
    padding: 9px 12px;
    border-radius: 8px;
    font-size: 0.82rem;
    color: var(--text-muted);
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: background 0.15s, color 0.15s;
  }
  .chat-item:hover { background: var(--surface2); color: var(--text); }
  .chat-item.active { background: var(--surface2); color: var(--accent); }

  .chat-history::-webkit-scrollbar { width: 4px; }
  .chat-history::-webkit-scrollbar-track { background: transparent; }
  .chat-history::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* ── MAIN ── */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  /* ── HAMBURGER (lives in sidebar header) ── */
  .hamburger {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 4px;
    flex-shrink: 0;
  }
  .hamburger span {
    display: block;
    width: 20px;
    height: 1.5px;
    background: var(--text-muted);
    border-radius: 2px;
    transition: background 0.2s;
  }
  .hamburger:hover span { background: var(--accent); }

  /* Floating hamburger shown when sidebar is closed */
  .hamburger-float {
    position: absolute;
    top: 16px;
    left: 16px;
    z-index: 20;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px;
    display: none;
    flex-direction: column;
    gap: 4px;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .hamburger-float span {
    display: block;
    width: 18px;
    height: 1.5px;
    background: var(--text-muted);
    border-radius: 2px;
    transition: background 0.2s;
  }
  .hamburger-float:hover span { background: var(--accent); }
  .hamburger-float.visible { display: flex; }


  /* ── MESSAGES ── */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 28px 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .message-row {
    display: flex;
    padding: 4px 24px;
    animation: fadeUp 0.3s ease forwards;
    opacity: 0;
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .message-row.user { justify-content: flex-end; }
  .message-row.ai   { justify-content: flex-start; }

  .bubble {
    max-width: 68%;
    padding: 12px 16px;
    border-radius: 14px;
    font-size: 0.9rem;
    line-height: 1.65;
    font-weight: 300;
  }
  .user .bubble {
    background: var(--user-bubble);
    border: 1px solid var(--user-border);
    border-bottom-right-radius: 4px;
    color: #c8e6c8;
  }
  .ai .bubble {
    background: var(--ai-bubble);
    border: 1px solid var(--ai-border);
    border-bottom-left-radius: 4px;
    color: var(--text);
  }

  /* ── TYPING INDICATOR ── */
  .typing-indicator {
    display: none;
    padding: 4px 24px;
  }
  .typing-indicator.visible { display: flex; }
  .dots {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 12px 16px;
    background: var(--ai-bubble);
    border: 1px solid var(--ai-border);
    border-radius: 14px;
    border-bottom-left-radius: 4px;
  }
  .dot {
    width: 7px; height: 7px;
    background: var(--text-muted);
    border-radius: 50%;
    animation: bounce 1.2s ease-in-out infinite;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%,60%,100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-6px); opacity: 1; }
  }

  /* ── EMPTY STATE ── */
  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: var(--text-muted);
    pointer-events: none;
    padding-bottom: 60px;
  }
  .empty-state h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    color: var(--accent);
    font-weight: 400;
  }
  .empty-state p { font-size: 0.85rem; }

  /* ── INPUT AREA ── */
  .input-area {
    padding: 20px 40px 28px;
    background: var(--bg);
    flex-shrink: 0;
  }
  .input-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 50px;
    padding: 10px 10px 10px 22px;
    transition: border-color 0.2s;
  }
  .input-wrap:focus-within { border-color: var(--accent2); }

  #user-input {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 300;
    resize: none;
    max-height: 160px;
    line-height: 1.5;
    padding: 2px 0;
  }
  #user-input::placeholder { color: var(--text-muted); }

  .send-btn {
    width: 38px; height: 38px;
    background: var(--accent2);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.2s, transform 0.1s;
  }
  .send-btn:hover { background: var(--accent); }
  .send-btn:active { transform: scale(0.94); }
  .send-btn svg { width: 16px; height: 16px; fill: #0e0e10; }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .input-footer {
    display: flex;
    justify-content: center;
    margin-top: 8px;
  }
  .input-footer span {
    font-size: 0.68rem;
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
  }

  /* ── ERROR TOAST ── */
  .toast {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #3b1212;
    border: 1px solid #7c2626;
    color: #f5a0a0;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 0.82rem;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
    z-index: 100;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Toggle sidebar">
      <span></span><span></span><span></span>
    </button>
    <span class="sidebar-logo">✦ Conversations</span>
  </div>
  <button class="new-chat-btn" onclick="newChat()">
    <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5">
      <line x1="6" y1="1" x2="6" y2="11"/><line x1="1" y1="6" x2="11" y2="6"/>
    </svg>
    New conversation
  </button>
  <div class="chat-history" id="chat-history">
    <div class="chat-history-label">Recent</div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <!-- Floating hamburger shown when sidebar is closed -->
  <button class="hamburger-float" id="hamburger-float" onclick="toggleSidebar()" aria-label="Open sidebar">
    <span></span><span></span><span></span>
  </button>

  <div class="messages" id="messages">
    <div class="empty-state" id="empty-state">
      <h2>Ask me anything.</h2>
      <p>Your conversation will appear here.</p>
    </div>
  </div>

  <div class="typing-indicator" id="typing-indicator">
    <div class="dots">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrap">
      <textarea id="user-input" rows="1" placeholder="Type your message…" autocomplete="off"></textarea>
      <button class="send-btn" id="send-btn" onclick="sendMessage()" aria-label="Send">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M2 21l21-9L2 3v7l15 2-15 2z"/>
        </svg>
      </button>
    </div>
    <div class="input-footer">
      <span>Press Enter to send · Shift+Enter for new line</span>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
  const API_URL = 'http://127.0.0.1:8000/chat';

  let sessions = [];        // [{id, title, messages}]
  let currentSessionId = null;

  // ── SIDEBAR ──────────────────────────────────
  let sidebarOpen = true;
  function toggleSidebar() {
    sidebarOpen = !sidebarOpen;
    document.getElementById('sidebar').classList.toggle('closed', !sidebarOpen);
    document.getElementById('hamburger-float').classList.toggle('visible', !sidebarOpen);
  }

  // ── SESSION MANAGEMENT ───────────────────────
  function newChat() {
    const id = Date.now();
    sessions.unshift({ id, title: 'New conversation', messages: [] });
    currentSessionId = id;
    renderHistory();
    renderMessages([]);
  }

  function getSession() {
    return sessions.find(s => s.id === currentSessionId);
  }

  function renderHistory() {
    const container = document.getElementById('chat-history');
    const label = container.querySelector('.chat-history-label');
    container.innerHTML = '';
    container.appendChild(label);
    sessions.forEach(s => {
      const div = document.createElement('div');
      div.className = 'chat-item' + (s.id === currentSessionId ? ' active' : '');
      div.textContent = s.title;
      div.onclick = () => { currentSessionId = s.id; renderHistory(); renderMessages(s.messages); };
      container.appendChild(div);
    });
  }

  // ── MESSAGES ─────────────────────────────────
  function renderMessages(messages) {
    const container = document.getElementById('messages');
    const emptyState = document.getElementById('empty-state');

    // Clear
    Array.from(container.querySelectorAll('.message-row')).forEach(el => el.remove());

    if (messages.length === 0) {
      emptyState.style.display = 'flex';
    } else {
      emptyState.style.display = 'none';
      messages.forEach(m => appendBubble(m.role, m.content, false));
    }
  }

  function appendBubble(role, content, animate = true) {
    const container = document.getElementById('messages');
    document.getElementById('empty-state').style.display = 'none';

    const row = document.createElement('div');
    row.className = `message-row ${role}`;
    if (!animate) row.style.animation = 'none', row.style.opacity = '1';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = content;

    row.appendChild(bubble);
    container.appendChild(row);
    container.scrollTop = container.scrollHeight;
  }

  function showTyping(show) {
    document.getElementById('typing-indicator').classList.toggle('visible', show);
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3500);
  }

  // ── SEND ─────────────────────────────────────
  async function sendMessage() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    if (!text) return;

    // Ensure a session exists
    if (currentSessionId === null) newChat();
    const session = getSession();

    input.value = '';
    input.style.height = 'auto';

    // Add to session
    session.messages.push({ role: 'user', content: text });
    if (session.title === 'New conversation') {
      session.title = text.length > 40 ? text.slice(0, 40) + '…' : text;
    }
    renderHistory();
    appendBubble('user', text);

    // Disable send
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    showTyping(true);

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_input: text, chat_history: session.messages.slice(0, -1).map(m => ({ role: m.role, content: m.content })) })
      });

      if (!res.ok) throw new Error(`Server error: ${res.status}`);
      const data = await res.json();
      const reply = data.final_response || data.response || data.message || JSON.stringify(data);

      session.messages.push({ role: 'ai', content: reply });
      showTyping(false);
      appendBubble('ai', reply);
    } catch (err) {
      showTyping(false);
      showToast('⚠ Could not reach the backend. Is it running on port 8000?');
      console.error(err);
    } finally {
      sendBtn.disabled = false;
      input.focus();
    }
  }

  // ── INPUT AUTO-RESIZE + ENTER ─────────────────
  const input = document.getElementById('user-input');
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 160) + 'px';
  });

  // Init with one empty session
  newChat();
</script>
</body>
</html>